<!DOCTYPE=HTML>
<html>
<style>

  #container {
    display: inline-block;
    position: relative;
  }

  #log {
    white-space: pre;
  }

  #canvas
  {
    border: 1px solid #000;
    height: 130px;
    width: 400px;
  }

  #content
  {
    position: absolute;
    padding: 10px;
    top: 0;
    left: 0;
    z-index: 1;
  }

  #hover:hover
  {
    color: red;
  }

</style>
<body id="body" onLoad = "setup()">
<h1>Touch fuzzing examples</h1>
  <div id="container">
    <canvas id="canvas" width="400" height="130"></canvas>
    <div id="content">
     Here is some text <a href='#' id='link'>with a link</a><br>
     And here is a superscript<sup><a href='#' id='superscript'>[1]</a></sup> which can be very hard to hit.<br>
     <span id='hover'>This text</span> has a hover effect<br>
     Here we have <span id='tabindex' tabindex=0>some text</span> with a tabindex<br>
     <span id='mousehandler'>This line has a mousedown event handler</span><br>
    </div>
  </div>
  <div id="log"></div>

<script>
  var dotRadius = 3;

  function setup() {

    var canvasScale = window.devicePixelRatio || 1;

    function $(name) {
      return document.getElementById(name);
    }


    function getPosition(node) {
      var r = node.getBoundingClientRect();
      return {
        x: r.left + document.body.scrollLeft,
        y: r.top + document.body.scrollTop
      }
    }

    function createHandlers(opt_params) {

      var target = $('container');
      var top, left, bottom, right;

      function onTouchEvent(e) {
        if (e.touches.length > 1 || (e.type=='touchend' && e.touches.length > 0))
          return; // ignore multi-touch
        var id = e.target.id;
        var canvas = $('canvas');
        var touch = e.changedTouches[0];
        var ctx = canvas.getContext('2d');

        if (e.type == 'touchstart') {
          top = Infinity;
          left = Infinity;
          bottom = -Infinity;
          right = -Infinity;
          $('log').textContent = '';
        }

        if (e.type != 'touchend') {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

	var radiusX = touch.webkitRadiusX;
	var radiusY = touch.webkitRadiusY;
	var drawTouchBorder = radiusX > 1 || radiusY > 1;
	if (radiusX > 1 && radiusY == 1)
	  radiusY = radiusX;   // only one radius supported

	var pt = getPosition(canvas);
	var offsetX = touch.pageX - pt.x;
	var offsetY = touch.pageY - pt.y;
	if (drawTouchBorder) {
	  ctx.beginPath();
	  ctx.strokeStyle = '#00FF00';
          ctx.lineWidth = 3;
          top = Math.min(top, (offsetY - radiusY) * canvasScale);
          left = Math.min(left, (offsetX - radiusX) * canvasScale);
          bottom = Math.max(bottom, (offsetY + radiusY) * canvasScale);
          right = Math.max(right, (offsetX + radiusX) * canvasScale);
          ctx.rect(left, top, right - left, bottom - top); 
	  ctx.stroke();
	}

        if (e.type == 'touchend') {
          ctx.fillStyle = '#FF0000';
          ctx.beginPath();
          ctx.arc(offsetX * canvasScale, offsetY * canvasScale, dotRadius * canvasScale, 0, 2*Math.PI, true);
          ctx.fill();
        }

        var msg = e.type + ': ' + touch.pageX + ', ' + touch.pageY + 
          ' (' + document.elementFromPoint(touch.pageX, touch.pageY).id +') radius=' + 
          touch.webkitRadiusX + 'x' + touch.webkitRadiusY + '\n';
        $('log').textContent += msg;
      }

      function onClick(e) {
        var id = e.target.id;
        var canvas = $('canvas');
        var ctx = canvas.getContext('2d');

        $('log').textContent += 'click: ' + e.pageX + ', ' + e.pageY + ' (' + id + ')\n';
        var pt = getPosition(canvas);
        var offsetX = e.pageX - pt.x;
        var offsetY = e.pageY - pt.y;
        ctx.fillStyle = '#0000FF';
        ctx.beginPath();
        ctx.arc(offsetX * canvasScale, offsetY * canvasScale, dotRadius * canvasScale, 0, 2*Math.PI, true);
        ctx.fill();
      }

      target.addEventListener('touchstart', onTouchEvent);
      target.addEventListener('touchend', onTouchEvent);
      target.addEventListener('touchmove', onTouchEvent);
      target.addEventListener('click', onClick);

      $('mousehandler').addEventListener('mousedown', function() {});

      $('canvas').width = $('canvas').clientWidth * canvasScale;
      $('canvas').height = $('canvas').clientHeight * canvasScale;
    }

    createHandlers();
  }
</script>
</body>
</html>

